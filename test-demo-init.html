<!DOCTYPE html>
<html>
<head>
    <title>Test Demo Data Initialization</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { margin: 5px 0; padding: 5px; border-left: 3px solid #ccc; }
        .success { border-color: #4CAF50; background: #f1f8e9; }
        .error { border-color: #f44336; background: #ffebee; }
        .info { border-color: #2196F3; background: #e3f2fd; }
        .warning { border-color: #ff9800; background: #fff3e0; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Test Demo Data Initialization</h1>
    <button onclick="testDemoInit()">🚀 Test Demo Init</button>
    <button onclick="clearStorage()">🗑️ Clear Storage</button>
    <button onclick="checkStorage()">🔍 Check Storage</button>
    
    <div id="output"></div>
    
    <script>
        const output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = message;
            output.appendChild(div);
            console.log(message);
        }
        
        function clearOutput() {
            output.innerHTML = '';
        }
        
        // Simulate the demo data
        const DEMO_QUIZZES = [{
            id: 'demo-quiz-1',
            publicId: 'lead-magnet-digital',
            name: 'Digital Marketing Lead Magnet Quiz',
            title: 'What\'s Your Digital Marketing Superpower?',
            description: 'Discover your unique digital marketing strengths and get personalized recommendations.',
            status: 'published',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            questions: [
                {
                    id: 'q1',
                    type: 'multiple_choice',
                    question: 'What\'s your biggest challenge in digital marketing?',
                    options: [
                        { id: 'a', text: 'Getting more traffic to my website', points: { 'seo': 3, 'content': 1 } },
                        { id: 'b', text: 'Converting visitors into customers', points: { 'conversion': 3, 'analytics': 1 } },
                        { id: 'c', text: 'Creating engaging content', points: { 'content': 3, 'social': 1 } },
                        { id: 'd', text: 'Managing social media effectively', points: { 'social': 3, 'content': 1 } }
                    ],
                    required: true
                }
            ],
            results: [
                {
                    id: 'seo',
                    title: 'SEO Specialist',
                    description: 'You have a natural talent for search engine optimization!',
                    minPoints: 0,
                    maxPoints: 10
                }
            ],
            settings: {
                collectEmail: true,
                showProgressBar: true,
                allowRetake: true,
                randomizeQuestions: false,
                theme: 'default'
            },
            leadMagnet: {
                enabled: true,
                title: 'Get Your Free Digital Marketing Guide',
                description: 'Download our comprehensive guide to boost your digital marketing results.',
                fileUrl: '/downloads/digital-marketing-guide.pdf'
            }
        }];
        
        // Simulate localStorage manager
        const STORAGE_KEYS = {
            QUIZZES: 'elevado_quizzes',
            RESULTS: 'elevado_results', 
            LEADS: 'elevado_leads',
            ANALYTICS: 'elevado_analytics',
            USER_PROFILE: 'elevado_user'
        };
        
        const localDB = {
            getItem: function(key) {
                try {
                    const data = localStorage.getItem(key);
                    if (!data) return [];
                    const parsed = JSON.parse(data);
                    return Array.isArray(parsed) ? parsed : [];
                } catch (error) {
                    console.error(`Error reading ${key}:`, error);
                    return [];
                }
            },
            
            setItem: function(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (error) {
                    console.error(`Error saving ${key}:`, error);
                }
            },
            
            getAllQuizzes: function() {
                return this.getItem(STORAGE_KEYS.QUIZZES);
            },
            
            saveQuiz: function(quiz) {
                const quizzes = this.getItem(STORAGE_KEYS.QUIZZES);
                const existingIndex = quizzes.findIndex(q => q.id === quiz.id);
                
                if (existingIndex >= 0) {
                    quizzes[existingIndex] = { ...quiz, updatedAt: new Date().toISOString() };
                } else {
                    quizzes.push(quiz);
                }
                
                this.setItem(STORAGE_KEYS.QUIZZES, quizzes);
            }
        };
        
        // Simulate initializeDemoData function
        function initializeDemoData() {
            try {
                log('🚀 initializeDemoData called', 'info');
                
                // Check if localStorage is available
                if (typeof window === 'undefined' || !window.localStorage) {
                    log('❌ localStorage not available', 'error');
                    return;
                }
                
                log('✅ localStorage is available', 'success');
                
                // Get existing quizzes
                const existingQuizzes = localDB.getAllQuizzes();
                log(`📊 Existing quizzes count: ${existingQuizzes.length}`, 'info');
                
                // Check if demo quiz exists
                const hasDemoQuiz = existingQuizzes.some(quiz => quiz.publicId === 'lead-magnet-digital');
                log(`🎯 Has demo quiz: ${hasDemoQuiz}`, hasDemoQuiz ? 'success' : 'warning');
                
                if (!hasDemoQuiz) {
                    log('💾 Initializing demo data in localStorage...', 'info');
                    
                    // Add each demo quiz
                    DEMO_QUIZZES.forEach((demoQuiz) => {
                        const existingQuiz = existingQuizzes.find(q => q.id === demoQuiz.id || q.publicId === demoQuiz.publicId);
                        
                        if (!existingQuiz) {
                            log(`💾 Saving quiz: ${demoQuiz.publicId}`, 'info');
                            localDB.saveQuiz(demoQuiz);
                            log(`✅ Demo quiz added: ${demoQuiz.name} (${demoQuiz.publicId})`, 'success');
                        } else {
                            log(`⚠️ Quiz already exists: ${demoQuiz.publicId}`, 'warning');
                        }
                    });
                    
                    // Verify data was saved
                    const updatedQuizzes = localDB.getAllQuizzes();
                    log(`📊 Quizzes after save: ${updatedQuizzes.length}`, 'info');
                    
                    const demoQuizExists = updatedQuizzes.some(quiz => quiz.publicId === 'lead-magnet-digital');
                    log(`🎯 Demo quiz exists after save: ${demoQuizExists}`, demoQuizExists ? 'success' : 'error');
                    
                    if (demoQuizExists) {
                        log('🚀 Demo data initialized successfully!', 'success');
                    } else {
                        log('❌ Failed to initialize demo data', 'error');
                    }
                } else {
                    log('✅ Demo data already exists in localStorage', 'success');
                }
            } catch (error) {
                log(`❌ Error initializing demo data: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        function testDemoInit() {
            clearOutput();
            log('🧪 Starting demo data initialization test...', 'info');
            initializeDemoData();
        }
        
        function clearStorage() {
            clearOutput();
            localStorage.clear();
            log('🗑️ localStorage cleared', 'warning');
        }
        
        function checkStorage() {
            clearOutput();
            log('🔍 Checking localStorage contents...', 'info');
            
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                keys.push(localStorage.key(i));
            }
            
            log(`📋 Total keys: ${keys.length}`, 'info');
            
            if (keys.length === 0) {
                log('⚠️ localStorage is empty', 'warning');
                return;
            }
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (key === STORAGE_KEYS.QUIZZES) {
                    try {
                        const quizzes = JSON.parse(value);
                        log(`🎯 Found ${quizzes.length} quizzes in storage`, 'success');
                        quizzes.forEach(quiz => {
                            log(`  - ${quiz.name} (${quiz.publicId}) - Status: ${quiz.status}`, 'info');
                        });
                    } catch (e) {
                        log(`❌ Error parsing quizzes: ${e.message}`, 'error');
                    }
                } else {
                    const preview = value ? value.substring(0, 50) + (value.length > 50 ? '...' : '') : 'null';
                    log(`🔑 ${key}: ${preview}`, 'info');
                }
            });
        }
        
        // Auto-check on load
        window.onload = function() {
            checkStorage();
        };
    </script>
</body>
</html>